-- Hub RayfieldUI completo aggiornato

local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Arise Hub",
    LoadingTitle = "Arise Hub",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "AriseHub",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false
})

-- Tab principali
local InfCastleTab = Window:CreateTab("InfCastle", 4483362458)
local InfDesertTab = Window:CreateTab("InfDesert", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- Variabili di stato
local castleStandEnabled = false
local castleAutoRestartEnabled = false
local castleWaveSpeed2Enabled = false

local desertStandEnabled = false
local desertAutoRestartEnabled = false
local desertWaveSpeed2Enabled = false
local desertWaveSpeed3Enabled = false

local autoClickEnabled = false

-- Coordinate predefinite
local castleCFrame = CFrame.new(-291, 96, 420)
local desertCFrame = CFrame.new(-3, 5, -190)

-- Funzione per teletrasporto sicuro
local function safeStandAt(cf)
    local plr = game.Players.LocalPlayer
    if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
        plr.Character:WaitForChild("HumanoidRootPart").CFrame = cf
    end
end

-- Funzione restart infinito
local function autoRestart()
    local args = {
        {
            [1] = {
                [1] = "InfiniteModeAction",
                [2] = "Restart"
            }
        }
    }
    for i = 1, 5 do
        pcall(function()
            game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
        end)
        task.wait(math.random(1, 3))
    end
end

-- Funzione speed (castle & desert)
local function fireSpeed(speed)
    local args = {
        {
            {
                Speed = speed,
                Event = "InfiniteModeAction",
                Action = "SpeedUp"
            },
            "\r"
        }
    }
    pcall(function()
        local bridge = game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2")
        local dataRemote = bridge:WaitForChild("dataRemoteEvent")
        dataRemote:FireServer(unpack(args))
    end)
end

-- InfCastle toggles
InfCastleTab:CreateToggle({
    Name = "Stand Safe (Castle)",
    CurrentValue = false,
    Flag = "InfCastleStand",
    Callback = function(value)
        castleStandEnabled = value
        if value then safeStandAt(castleCFrame) end
    end
})

InfCastleTab:CreateToggle({
    Name = "Auto Restart",
    CurrentValue = false,
    Flag = "InfCastleAutoRestart",
    Callback = function(value)
        castleAutoRestartEnabled = value
    end
})

InfCastleTab:CreateToggle({
    Name = "Wave Speed 2",
    CurrentValue = false,
    Flag = "InfCastleWaveSpeed2",
    Callback = function(value)
        castleWaveSpeed2Enabled = value
        if value then
            local plr = game.Players.LocalPlayer
            if plr and plr.Character then
                task.spawn(function()
                    task.wait(5)
                    if castleWaveSpeed2Enabled then pcall(fireSpeed, 2) end
                end)
            end
        end
    end
})

-- InfDesert toggles
InfDesertTab:CreateToggle({
    Name = "Stand Safe (Desert)",
    CurrentValue = false,
    Flag = "InfDesertStand",
    Callback = function(value)
        desertStandEnabled = value
        if value then safeStandAt(desertCFrame) end
    end
})

InfDesertTab:CreateToggle({
    Name = "Auto Restart",
    CurrentValue = false,
    Flag = "InfDesertAutoRestart",
    Callback = function(value)
        desertAutoRestartEnabled = value
    end
})

-- Wave Speed 2 (mutuo con 3)
InfDesertTab:CreateToggle({
    Name = "Wave Speed 2",
    CurrentValue = false,
    Flag = "InfDesertWaveSpeed2",
    Callback = function(value)
        if value then
            if desertWaveSpeed3Enabled then
                desertWaveSpeed3Enabled = false
                Rayfield.Flags["InfDesertWaveSpeed3"].Set(false)
            end
            desertWaveSpeed2Enabled = true
            local plr = game.Players.LocalPlayer
            if plr and plr.Character then
                task.spawn(function()
                    task.wait(5)
                    if desertWaveSpeed2Enabled then pcall(fireSpeed, 2) end
                end)
            end
        else
            desertWaveSpeed2Enabled = false
        end
    end
})

-- Wave Speed 3 (mutuo con 2)
InfDesertTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "InfDesertWaveSpeed3",
    Callback = function(value)
        if value then
            if desertWaveSpeed2Enabled then
                desertWaveSpeed2Enabled = false
                Rayfield.Flags["InfDesertWaveSpeed2"].Set(false)
            end
            desertWaveSpeed3Enabled = true
            local plr = game.Players.LocalPlayer
            if plr and plr.Character then
                task.spawn(function()
                    task.wait(5)
                    if desertWaveSpeed3Enabled then pcall(fireSpeed, 3) end
                end)
            end
        else
            desertWaveSpeed3Enabled = false
        end
    end
})

-- Misc tab (AutoClick)
MiscTab:CreateToggle({
    Name = "Auto Click",
    CurrentValue = false,
    Flag = "MiscAutoClick",
    Callback = function(value)
        autoClickEnabled = value
        task.spawn(function()
            while autoClickEnabled do
                game:GetService("VirtualUser"):Button1Down(Vector2.new(0,0))
                game:GetService("VirtualUser"):Button1Up(Vector2.new(0,0))
                task.wait(0.1)
            end
        end)
    end
})

-- Eventi OnClientEvent per AutoRestart
local function deepSearch(tbl, target)
    for _, v in pairs(tbl) do
        if type(v) == "table" then
            if deepSearch(v, target) then return true end
        elseif type(v) == "string" and string.find(v, target) then
            return true
        end
    end
    return false
end

game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent").OnClientEvent:Connect(function(...)
    local args = {...}
    if deepSearch(args, "PORTAL DESTROYED") then
        if castleAutoRestartEnabled or desertAutoRestartEnabled then
            autoRestart()
        end
    end
end)

-- CharacterAdded handler per riposizionamenti e wave speed
local player = game.Players.LocalPlayer
if player then
    player.CharacterAdded:Connect(function(char)
        task.spawn(function()
            task.wait(5)
            if castleStandEnabled then safeStandAt(castleCFrame) end
            if desertStandEnabled then safeStandAt(desertCFrame) end
            if castleWaveSpeed2Enabled then pcall(fireSpeed, 2) end
            if desertWaveSpeed2Enabled then pcall(fireSpeed, 2) end
            if desertWaveSpeed3Enabled then pcall(fireSpeed, 3) end
        end)
    end)
end
