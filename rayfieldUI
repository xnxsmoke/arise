local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local BridgeNet2 = ReplicatedStorage:WaitForChild("BridgeNet2")
local Bridge = require(BridgeNet2).ReferenceBridge("GENERAL_EVENT")
local dataRemoteEvent = BridgeNet2:WaitForChild("dataRemoteEvent")

local function fireSafe(data)
    pcall(function()
        Bridge:Fire(data)
    end)
end

local function safeStandAt(cf)
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = cf
    end
end

local function safeRejoin(fn)
    task.spawn(function()
        local tries = 0
        while tries < 5 do
            local ok = pcall(fn)
            if ok then break end
            tries += 1
            task.wait(math.random(3, 6))
        end
    end)
end

local function speedUp(eventName, speed)
    task.spawn(function()
        repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        task.wait(2)
        fireSafe({
            Event = eventName,
            Action = "SpeedUp",
            Speed = speed
        })
    end)
end

local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.9814, 1594.4941, -4312.1958)

local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = {
        Enabled = true,
        FileName = "InfiniteModesHub",
        AutoSave = true
    },
})

local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

local standCastleEnabled, standDesertEnabled, standCemetryRushEnabled = false, false, false
local autoRestartCastle, autoRestartDesert, autoRestartLabyrinth, autoRestartCemetryRush = false, false, false, false
local cemetryRushDifficulty, useCemetryRushMode = "Insane", false
local autoClickEnabled, autoBloodWeaponSwitch = false, false

-- CHECKPOINT LIST
local checkpoints = {}
for i = 0, 360, 30 do table.insert(checkpoints, tostring(i)) end

local selectedCastleCheckpoint = "0"
local selectedDesertCheckpoint = "0"

---------------------------------------------------------------------
-- INF CASTLE
---------------------------------------------------------------------

CastleTab:CreateButton({
    Name = "Start Infinite Castle (Manual)",
    Callback = function()
        if selectedCastleCheckpoint == "0" then
            fireSafe({ Event = "InfiniteCastleAction", Action = "Create" })
            task.wait(1)
            fireSafe({ Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" })
        else
            fireSafe({
                Event = "InfiniteCastleAction",
                Action = "Start",
                Dungeon = 3604563306,
                Check = selectedCastleCheckpoint
            })
        end
        
        task.wait(1)
        if standCastleEnabled then safeStandAt(castleCFrame) end
    end
})

CastleTab:CreateDropdown({
    Name = "Castle Checkpoint",
    Options = checkpoints,
    CurrentOption = "0",
    Flag = "CastleCheckpointFlag",
    Callback = function(opt)
        selectedCastleCheckpoint = opt
    end
})

CastleTab:CreateToggle({
    Name = "Stand in the Middle (InfCastle)",
    CurrentValue = false,
    Flag = "StandCastleFlag",
    Callback = function(v)
        standCastleEnabled = v
        if v then safeStandAt(castleCFrame) end
    end
})

CastleTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartCastleFlag",
    Callback = function(v)
        autoRestartCastle = v
    end
})

CastleTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3CastleFlag",
    Callback = function(v)
        if v then speedUp("InfiniteCastleAction", 3) end
    end
})

---------------------------------------------------------------------
-- INF DESERT
---------------------------------------------------------------------

DesertTab:CreateButton({
    Name = "Start Infinite Desert (Manual)",
    Callback = function()
        if selectedDesertCheckpoint == "0" then
            fireSafe({ Event = "InfiniteModeAction", Action = "Create" })
            task.wait(1)
            fireSafe({ Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" })
        else
            fireSafe({
                Event = "InfiniteModeAction",
                Action = "Start",
                Dungeon = 3604563306,
                Check = selectedDesertCheckpoint
            })
        end
        
        task.wait(1)
        if standDesertEnabled then safeStandAt(desertCFrame) end
    end
})

DesertTab:CreateDropdown({
    Name = "Desert Checkpoint",
    Options = checkpoints,
    CurrentOption = "0",
    Flag = "DesertCheckpointFlag",
    Callback = function(opt)
        selectedDesertCheckpoint = opt
    end
})

DesertTab:CreateToggle({
    Name = "Stand in the Middle (InfDesert)",
    CurrentValue = false,
    Flag = "StandDesertFlag",
    Callback = function(v)
        standDesertEnabled = v
        if v then safeStandAt(desertCFrame) end
    end
})

DesertTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartDesertFlag",
    Callback = function(v)
        autoRestartDesert = v
    end
})

DesertTab:CreateToggle({
    Name = "Wave Speed 2",
    CurrentValue = false,
    Flag = "WaveSpeed2DesertFlag",
    Callback = function(v)
        if v then speedUp("InfiniteModeAction", 2) end
    end
})

DesertTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3DesertFlag",
    Callback = function(v)
        if v then speedUp("InfiniteModeAction", 3) end
    end
})

---------------------------------------------------------------------
-- INF LAB
---------------------------------------------------------------------

local function startLabyrinth()
    fireSafe({ Event = "InfiniteLabyrinthAction", Action = "Create" })
    task.wait(1)
    fireSafe({ Dungeon = 3604563306, Event = "InfiniteLabyrinthAction", Action = "Start" })
end

LabTab:CreateButton({
    Name = "Start Infinite Labyrinth (Manual)",
    Callback = startLabyrinth
})

LabTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartLabyrinthFlag",
    Callback = function(v)
        autoRestartLabyrinth = v
    end
})

LabTab:CreateToggle({
    Name = "Speed 3",
    CurrentValue = false,
    Flag = "Speed3LabyrinthFlag",
    Callback = function(v)
        if v then speedUp("InfiniteLabyrinthAction", 3) end
    end
})

---------------------------------------------------------------------
-- CEMETRY RUSH
---------------------------------------------------------------------

local function startCemetryRush()
    if not useCemetryRushMode then return end
    fireSafe({ Event = "BossRushAction", Action = "Create" })
    task.wait(1)
    fireSafe({
        Dungeon = 3604563306,
        Action = "Start",
        Diff = cemetryRushDifficulty,
        Event = "BossRushAction"
    })

    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end

CemetryRushTab:CreateButton({
    Name = "Start CemetryRush (Manual)",
    Callback = startCemetryRush
})

CemetryRushTab:CreateToggle({
    Name = "Stand in the Middle",
    CurrentValue = false,
    Flag = "StandCemetryRushFlag",
    Callback = function(v)
        standCemetryRushEnabled = v
        if v then safeStandAt(cemetryRushCFrame) end
    end
})

CemetryRushTab:CreateDropdown({
    Name = "Select Difficulty",
    Options = {"Easy", "Medium", "Hard", "Insane"},
    CurrentOption = "Insane",
    Flag = "CemetryRushDifficultyFlag",
    Callback = function(opt)
        cemetryRushDifficulty = opt
    end
})

CemetryRushTab:CreateToggle({
    Name = "Activate Selected Difficulty",
    CurrentValue = false,
    Flag = "UseCemetryRushDifficultyFlag",
    Callback = function(v)
        useCemetryRushMode = v
    end
})

CemetryRushTab:CreateToggle({
    Name = "Auto-Restart (on Rush Ended)",
    CurrentValue = false,
    Flag = "AutoRestartCemetryRushFlag",
    Callback = function(v)
        autoRestartCemetryRush = v
    end
})

---------------------------------------------------------------------
-- MISC
---------------------------------------------------------------------

MiscTab:CreateToggle({
    Name = "Auto Click (PunchAttack, Fast)",
    CurrentValue = false,
    Flag = "AutoClickFlag",
    Callback = function(v)
        autoClickEnabled = v
        if v then
            task.spawn(function()
                while autoClickEnabled do
                    task.wait(0.01)
                    fireSafe({ Event = "PunchAttack" })
                end
            end)
        end
    end
})

MiscTab:CreateToggle({
    Name = "Auto Blood Weapon Switch",
    CurrentValue = false,
    Flag = "AutoBloodWeaponSwitchFlag",
    Callback = function(v)
        autoBloodWeaponSwitch = v
        if v then
            task.spawn(function()
                while autoBloodWeaponSwitch do
                    fireSafe({ Action = "Equip", Event = "Teams", TeamId = "ced2" })
                    task.wait(2)
                    fireSafe({ Action = "Equip", Event = "Teams", TeamId = "f2ae" })
                    task.wait(15)
                end
            end)
        end
    end
})

---------------------------------------------------------------------
-- AUTO RESTART SYSTEM
---------------------------------------------------------------------

dataRemoteEvent.OnClientEvent:Connect(function(...)
    local function scan(tbl)
        if type(tbl) ~= "table" then return end
        for _, v in pairs(tbl) do
            if type(v) == "table" then
                scan(v)
            elseif type(v) == "string" then
                local msg = v:upper()

                if msg:find("PORTAL") and msg:find("DESTROY") then
                    if autoRestartCastle then
                        if selectedCastleCheckpoint == "0" then
                            fireSafe({ Event = "InfiniteCastleAction", Action = "Create" })
                            task.wait(1)
                            fireSafe({ Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" })
                        else
                            fireSafe({
                                Event = "InfiniteCastleAction",
                                Action = "Start",
                                Dungeon = 3604563306,
                                Check = selectedCastleCheckpoint
                            })
                        end
                    end

                    if autoRestartDesert then
                        if selectedDesertCheckpoint == "0" then
                            fireSafe({ Event = "InfiniteModeAction", Action = "Create" })
                            task.wait(1)
                            fireSafe({ Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" })
                        else
                            fireSafe({
                                Event = "InfiniteModeAction",
                                Action = "Start",
                                Dungeon = 3604563306,
                                Check = selectedDesertCheckpoint
                            })
                        end
                    end

                    if autoRestartLabyrinth then
                        safeRejoin(startLabyrinth)
                    end
                end

                if msg:find("RUSH") and msg:find("END") then
                    if autoRestartCemetryRush then
                        safeRejoin(startCemetryRush)
                    end
                end
            end
        end
    end

    for _, v in ipairs({...}) do scan(v) end
end)

---------------------------------------------------------------------
-- RESPAWN
---------------------------------------------------------------------

player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end)

---------------------------------------------------------------------
-- LOAD CONFIG
---------------------------------------------------------------------

Rayfield:LoadConfiguration("InfiniteModesHub")
