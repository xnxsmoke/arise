local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- =================== Coordinate ===================
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local bossRushCFrame = CFrame.new(216.035507, 1594.49414, -4315.56738)

-- =================== Window ===================
local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true },
})

-- =================== Tabs ===================
local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local BossRushTab = Window:CreateTab("BossRush", 4483362458)
local HospRaidTab = Window:CreateTab("HospRaid", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- =================== Variabili ===================
local standCastleEnabled = false
local standDesertEnabled = false
local autoRestartCastle = false
local autoRestartDesert = false
local autoRestartLabyrinth = false
local autoRestartBossRush = false
local hospRaidEnabled = false

-- =================== Utility ===================
local function safeStandAt(cf)
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        pcall(function() char.HumanoidRootPart.CFrame = cf end)
    end
end

local function fireSafe(args)
    pcall(function() dataRemoteEvent:FireServer(unpack(args)) end)
end

local function safeRejoin(joinFunction)
    task.spawn(function()
        local success = false
        for i = 1, 5 do
            print("[AutoRejoin] Tentativo #" .. i)
            task.wait(math.random(3,6))
            local ok, err = pcall(joinFunction)
            if ok then
                print("[AutoRejoin] Join completato!")
                success = true
                break
            else
                warn("[AutoRejoin] Errore: " .. tostring(err))
            end
        end
        if not success then warn("[AutoRejoin] Falliti 5 tentativi.") end
    end)
end

-- =================== Infinite Castle ===================
local function startCastle()
    fireSafe({ { { Event = "InfiniteCastleAction", Action = "Create" }, "\014" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" }, "\014" } })
    if standCastleEnabled then safeStandAt(castleCFrame) end
end
local function restartCastle() safeRejoin(startCastle) end

CastleTab:CreateButton({ Name = "Start Infinite Castle (Manual)", Callback = startCastle })
CastleTab:CreateToggle({ Name = "Stand in the Middle (InfCastle)", CurrentValue = false, Callback = function(v) standCastleEnabled = v if v then safeStandAt(castleCFrame) end end })
CastleTab:CreateToggle({ Name = "Auto-Restart (on Portal Destroyed)", CurrentValue = false, Callback = function(v) autoRestartCastle = v end })

-- =================== Infinite Desert ===================
local function startDesert()
    fireSafe({ { { Event = "InfiniteModeAction", Action = "Create" }, "\014" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" }, "\014" } })
    if standDesertEnabled then safeStandAt(desertCFrame) end
end
local function restartDesert() safeRejoin(startDesert) end

DesertTab:CreateButton({ Name = "Start Infinite Desert (Manual)", Callback = startDesert })
DesertTab:CreateToggle({ Name = "Stand in the Middle (InfDesert)", CurrentValue = false, Callback = function(v) standDesertEnabled = v if v then safeStandAt(desertCFrame) end end })
DesertTab:CreateToggle({ Name = "Auto-Restart (on Portal Destroyed)", CurrentValue = false, Callback = function(v) autoRestartDesert = v end })

-- =================== Infinite Labyrinth ===================
local function startLabyrinth()
    fireSafe({ { { Event = "InfiniteLabyrinthAction", Action = "Create" }, "\014" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteLabyrinthAction", Action = "Start" }, "\014" } })
end
local function restartLabyrinth() safeRejoin(startLabyrinth) end
LabTab:CreateButton({ Name = "Start Infinite Labyrinth (Manual)", Callback = startLabyrinth })
LabTab:CreateToggle({ Name = "Auto-Restart (on Portal Destroyed)", CurrentValue = false, Callback = function(v) autoRestartLabyrinth = v end })

-- =================== BossRush ===================
local function startBossRush(mode)
    task.spawn(function()
        -- Step 1: Create BossRush
        fireSafe({ { Event = "BossRushAction", Action = "Create" } })
        print("[BossRush] Lobby Create inviata")
        task.wait(1.5) -- attendi generazione della lobby

        -- Step 2: Start BossRush
        fireSafe({ { Event = "BossRushAction", Action = "Start", Dungeon = 3604563306, Diff = mode or "Normal" } })
        print("[BossRush] Start inviata con modalit√†:", mode)

        -- Step 3: Aspetta che la spawn area sia pronta
        local ws = game:GetService("Workspace")
        repeat task.wait(0.1) until ws:FindFirstChild("__MAP") or ws:FindFirstChild("BossRushSpawn")

        -- Step 4: Teletrasporto sicuro
        repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        task.wait(0.2)
        safeStandAt(bossRushCFrame)
        print("[BossRush] Teletrasporto completato")
    end)
end
local function restartBossRush() safeRejoin(function() startBossRush("Normal") end) end

BossRushTab:CreateButton({ Name = "Start BossRush (Manual)", Callback = function() startBossRush("Normal") end })
BossRushTab:CreateToggle({ Name = "Auto-Restart (on Rush Ended)", CurrentValue = false, Callback = function(v) autoRestartBossRush = v end })
BossRushTab:CreateToggle({ Name = "Stand in the Middle (BossRush)", CurrentValue = false, Callback = function(v) if v then safeStandAt(bossRushCFrame) end end })

-- =================== HospRaid ===================
local function isInHospRaid()
    local ws = game:GetService("Workspace")
    return ws:FindFirstChild("__MAP") or ws:FindFirstChild("RaidBoss")
end

local function joinHospRaid()
    if isInHospRaid() then return end
    fireSafe({ { Event = "HLRaidAction", Action = "Join" } })
    print("[HospRaid] Tentativo di join eseguito.")
end

HospRaidTab:CreateToggle({
    Name = "Auto Join HospRaid",
    CurrentValue = false,
    Callback = function(Value)
        hospRaidEnabled = Value
        if Value then
            task.spawn(function()
                while hospRaidEnabled do
                    task.wait(5)
                    if not isInHospRaid() then
                        joinHospRaid()
                    end
                end
            end)
        end
    end
})

-- =================== Misc ===================
local autoClickEnabled = false
MiscTab:CreateToggle({
    Name = "Auto Click",
    CurrentValue = false,
    Callback = function(Value)
        autoClickEnabled = Value
        if Value then
            task.spawn(function()
                local WeaponsModule = require(game:GetService("ReplicatedStorage").SharedModules.WeaponsModule)
                while autoClickEnabled do
                    task.wait(0.1)
                    pcall(function()
                        WeaponsModule.Click({KeyCode = Enum.KeyCode.ButtonX}, false, nil, true)
                    end)
                end
            end)
        end
    end
})

-- =================== Auto Restart & Respawn ===================
player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
end)

dataRemoteEvent.OnClientEvent:Connect(function(...)
    local args = {...}
    local function recursiveCheck(tbl)
        if type(tbl) ~= "table" then return end
        for k, v in pairs(tbl) do
            if type(v) == "table" then
                recursiveCheck(v)
            elseif k == "Message" and type(v) == "string" then
                local msg = v:upper()
                if msg:find("PORTAL DESTROYED") then
                    if autoRestartCastle then restartCastle() end
                    if autoRestartDesert then restartDesert() end
                    if autoRestartLabyrinth then restartLabyrinth() end
                elseif msg:find("RUSH ENDED") then
                    if autoRestartBossRush then restartBossRush() end
                end
            end
        end
    end
    for _, v in ipairs(args) do recursiveCheck(v) end
end)

-- =================== Load Configuration ===================
Window:LoadConfiguration("InfiniteModesHub") -- AutoSave funzionante
