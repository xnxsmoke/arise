local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local BridgeNet2 = ReplicatedStorage:WaitForChild("BridgeNet2")
local Bridge = require(BridgeNet2).ReferenceBridge("GENERAL_EVENT")
local dataRemoteEvent = BridgeNet2:WaitForChild("dataRemoteEvent")

local function fireSafe(data)
    pcall(function() Bridge:Fire(data) end)
end

local function safeStandAt(cf)
    local c = player.Character
    if c and c:FindFirstChild("HumanoidRootPart") then
        c.HumanoidRootPart.CFrame = cf
    end
end

local function safeRejoin(fn)
    task.spawn(function()
        for i = 1, 5 do
            if pcall(fn) then return end
            task.wait(math.random(3, 6))
        end
    end)
end

local function speedUp(eventName, speed)
    task.spawn(function()
        repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        task.wait(2)
        fireSafe({Event = eventName, Action = "SpeedUp", Speed = speed})
    end)
end

local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.9814, 1594.4941, -4312.1958)

local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true }
})

local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local HospRaidTab = Window:CreateTab("HospRaid", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

local standCastleEnabled, autoRestartCastle = false, false

local function startCastle()
    fireSafe({Event = "InfiniteCastleAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteCastleAction", Action = "Start", Dungeon = 3604563306})
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
end

local function restartCastle()
    safeRejoin(startCastle)
end

CastleTab:CreateButton({Name = "Start Infinite Castle (Manual)", Callback = startCastle})
CastleTab:CreateToggle({
    Name = "Stand in the Middle (InfCastle)",
    CurrentValue = false,
    Flag = "StandCastleFlag",
    Callback = function(v)
        standCastleEnabled = v
        if v then safeStandAt(castleCFrame) end
    end
})
CastleTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartCastleFlag",
    Callback = function(v) autoRestartCastle = v end
})
CastleTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3CastleFlag",
    Callback = function(v) if v then speedUp("InfiniteCastleAction", 3) end end
})

local standDesertEnabled, autoRestartDesert = false, false

local function startDesert()
    fireSafe({Event = "InfiniteModeAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteModeAction", Action = "Start", Dungeon = 3604563306})
    task.wait(1)
    if standDesertEnabled then safeStandAt(desertCFrame) end
end

local function restartDesert()
    safeRejoin(startDesert)
end

DesertTab:CreateButton({Name = "Start Infinite Desert (Manual)", Callback = startDesert})
DesertTab:CreateToggle({
    Name = "Stand in the Middle (InfDesert)",
    CurrentValue = false,
    Flag = "StandDesertFlag",
    Callback = function(v)
        standDesertEnabled = v
        if v then safeStandAt(desertCFrame) end
    end
})
DesertTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartDesertFlag",
    Callback = function(v) autoRestartDesert = v end
})
DesertTab:CreateToggle({
    Name = "Wave Speed 2",
    CurrentValue = false,
    Flag = "WaveSpeed2DesertFlag",
    Callback = function(v) if v then speedUp("InfiniteModeAction", 2) end end
})
DesertTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3DesertFlag",
    Callback = function(v) if v then speedUp("InfiniteModeAction", 3) end end
})

local autoRestartLabyrinth = false

local function startLabyrinth()
    fireSafe({Event = "InfiniteLabyrinthAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteLabyrinthAction", Action = "Start", Dungeon = 3604563306})
end

local function restartLabyrinth()
    safeRejoin(startLabyrinth)
end

LabTab:CreateButton({Name = "Start Infinite Labyrinth (Manual)", Callback = startLabyrinth})
LabTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartLabyrinthFlag",
    Callback = function(v) autoRestartLabyrinth = v end
})
LabTab:CreateToggle({
    Name = "Speed 3",
    CurrentValue = false,
    Flag = "Speed3LabyrinthFlag",
    Callback = function(v) if v then speedUp("InfiniteLabyrinthAction", 3) end end
})

-- CemetryRush/BossRush sezione
local standCemetryRushEnabled, autoRestartCemetryRush, autoRestartAtWave = false, false, false
local cemetryRushDifficulty = "Insane"
local useSelectedDifficulty = false
local targetWave = 0
local currentWave = 0
local waveLabelConnected = {}

CemetryRushTab:CreateInput({
    Name = "Restart alla Wave",
    PlaceholderText = "Es. 20",
    RemoveTextAfterFocusLost = false,
    Flag = "WaveRestartValue",
    Callback = function(txt)
        local n = tonumber(txt)
        targetWave = n and n > 0 and math.floor(n) or 0
    end
})

CemetryRushTab:CreateToggle({
    Name = "Attiva Restart alla Wave",
    CurrentValue = false,
    Flag = "AutoRestartWaveFlag",
    Callback = function(v)
        autoRestartAtWave = v
    end
})

-- Dropdown per difficoltà
CemetryRushTab:CreateDropdown({
    Name = "Select Difficulty",
    Options = {"Easy","Medium","Hard","Insane","Ultra"},
    CurrentOption = cemetryRushDifficulty,
    Flag = "CemetryRushDifficultyFlag",
    Callback = function(opt)
        cemetryRushDifficulty = typeof(opt) == "table" and (opt.Name or opt[1]) or tostring(opt)
        print("[DEBUG] Difficulty selected:", cemetryRushDifficulty)
    end
})

-- Toggle per abilitare la difficoltà selezionata
CemetryRushTab:CreateToggle({
    Name = "Usa la difficoltà selezionata",
    CurrentValue = false,
    Flag = "UseSelectedDifficultyFlag",
    Callback = function(v)
        useSelectedDifficulty = v
        print("[DEBUG] Usa selezione:", v)
    end
})

local function startCemetryRush()
    print("[DEBUG] Try BossRush Start, UseSelected:", useSelectedDifficulty, "Diff:", cemetryRushDifficulty)
    fireSafe({Event = "BossRushAction", Action = "Create"})
    task.wait(1)
    local diff = useSelectedDifficulty and cemetryRushDifficulty or "Insane"
    fireSafe({
        Event = "BossRushAction",
        Action = "Start",
        Dungeon = 3604563306,
        Diff = diff,
        Wave = targetWave > 0 and targetWave or nil
    })
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end

local function restartCemetryRush()
    safeRejoin(startCemetryRush)
end

CemetryRushTab:CreateButton({Name = "Start CemetryRush (Manual)", Callback = startCemetryRush})
CemetryRushTab:CreateToggle({
    Name = "Stand in the Middle",
    CurrentValue = false,
    Flag = "StandCemetryRushFlag",
    Callback = function(v)
        standCemetryRushEnabled = v
        if v then safeStandAt(cemetryRushCFrame) end
    end
})
CemetryRushTab:CreateToggle({
    Name = "Auto-Restart (on Rush Ended)",
    CurrentValue = false,
    Flag = "AutoRestartCemetryRushFlag",
    Callback = function(v) autoRestartCemetryRush = v end
})

local function detectWaveLabel(lbl)
    if not lbl:IsA("TextLabel") then return end
    if waveLabelConnected[lbl] then return end
    if not lbl.Text:lower():find("wave") then return end

    waveLabelConnected[lbl] = true
    lbl:GetPropertyChangedSignal("Text"):Connect(function()
        local wave = tonumber(lbl.Text:match("[Ww]ave[^%d]*(%d+)"))
        if wave then
            currentWave = wave
            if autoRestartAtWave and targetWave > 0 and wave >= targetWave then
                autoRestartAtWave = false
                restartCemetryRush()
            end
        end
    end)
end

task.spawn(function()
    local gui = player:WaitForChild("PlayerGui")
    for _,v in ipairs(gui:GetDescendants()) do
        detectWaveLabel(v)
    end
    gui.DescendantAdded:Connect(detectWaveLabel)
end)

local joinedHospRaid = false
HospRaidTab:CreateToggle({
    Name = "Join HospRaid",
    CurrentValue = false,
    Flag = "JoinHospRaidFlag",
    Callback = function(v)
        if v and not joinedHospRaid then
            joinedHospRaid = true
            fireSafe({Event="HLRaidAction", Action="Join"})
        end
    end
})

local InfCastleTab = Window:CreateTab("InfCastle", 4483362458)

-- Variabili InfCastle
local autoResetRejoinCastle = false
local targetWaveCastle = 0
local currentWaveCastle = 0
local waveLabelConnectedCastle = {}
local selectedCastleFloor = nil -- floor scelto dall'utente
local autoInfCastleSpeed = false
local selectedCastleSpeed = 4

-- Funzione Reset con gemme
local function resetCastleWithGems()
    fireSafe({
        Event = "CastleAction",
        Action = "Reset",
        Type = "Gem"
    })
end

-- Funzione Join Castle (senza floor)
local function joinCastleNoFloor()
    fireSafe({
        Event = "CastleAction",
        Action = "Join",
        Check = false
    })
end

-- Funzione Join Castle con floor
local function joinCastleFloor(floor)
    fireSafe({
        Event = "CastleAction",
        Action = "Join",
        Check = true,
        Floor = tostring(floor)
    })
end

-- Funzione Reset + Rejoin
local function resetAndRejoinCastle()
    resetCastleWithGems()
    task.wait(2)
    if selectedCastleFloor then
        joinCastleFloor(selectedCastleFloor)
    else
        joinCastleNoFloor()
    end
end

-- Pulsante Join senza floor
InfCastleTab:CreateButton({
    Name = "Join Castle (No Floor)",
    Callback = joinCastleNoFloor
})

-- Input per Join con floor
InfCastleTab:CreateInput({
    Name = "Join Castle con Floor",
    PlaceholderText = "Es. 10",
    RemoveTextAfterFocusLost = false,
    Flag = "CastleFloorInput",
    Callback = function(txt)
        local n = tonumber(txt)
        if n and n > 0 then
            selectedCastleFloor = tostring(math.floor(n))
            joinCastleFloor(selectedCastleFloor)
        end
    end
})

-- Input per wave di uscita/rejoin
InfCastleTab:CreateInput({
    Name = "Reset+Rejoin alla Wave",
    PlaceholderText = "Es. 20",
    RemoveTextAfterFocusLost = false,
    Flag = "CastleWaveExitValue",
    Callback = function(txt)
        local n = tonumber(txt)
        targetWaveCastle = n and n > 0 and math.floor(n) or 0
    end
})

-- Toggle per attivare reset+rejoin
InfCastleTab:CreateToggle({
    Name = "Attiva reset+rejoin alla Wave",
    CurrentValue = false,
    Flag = "AutoResetRejoinCastleFlag",
    Callback = function(v)
        autoResetRejoinCastle = v
    end
})

-- Toggle per attivare auto speed
InfCastleTab:CreateToggle({
    Name = "Auto Inf Castle Speed",
    CurrentValue = false,
    Flag = "AutoInfCastleSpeedFlag",
    Callback = function(v)
        autoInfCastleSpeed = v
    end
})

-- Input per selezionare la velocità
InfCastleTab:CreateInput({
    Name = "[Inf Castle] Select Speed",
    PlaceholderText = "Es. 1, 2 o 4",
    RemoveTextAfterFocusLost = false,
    Flag = "InfCastleSpeedInput",
    Callback = function(txt)
        local speed = tonumber(txt)
        if speed == 1 or speed == 2 or speed == 4 then
            selectedCastleSpeed = speed
            fireSafe({
                Event = "CastleAction",
                Action = "SpeedUp",
                Speed = speed
            })
        else
            warn("[InfCastle] Velocità non valida:", txt)
        end
    end
})

-- Rilevamento wave label
local function detectCastleWaveLabel(lbl)
    if not lbl:IsA("TextLabel") then return end
    if waveLabelConnectedCastle[lbl] then return end
    if not lbl.Text:lower():find("wave") then return end

    waveLabelConnectedCastle[lbl] = true
    lbl:GetPropertyChangedSignal("Text"):Connect(function()
        local wave = tonumber(lbl.Text:match("[Ww]ave[^%d]*(%d+)"))
        if wave then
            currentWaveCastle = wave
            if autoResetRejoinCastle and targetWaveCastle > 0 and wave >= targetWaveCastle then
                autoResetRejoinCastle = false
                resetAndRejoinCastle()
            end
        end
    end)
end

-- Hook GUI per rilevare wave
task.spawn(function()
    local gui = player:WaitForChild("PlayerGui")
    for _,v in ipairs(gui:GetDescendants()) do
        detectCastleWaveLabel(v)
    end
    gui.DescendantAdded:Connect(detectCastleWaveLabel)
end)

-- SpeedUp automatico all'ingresso
player.CharacterAdded:Connect(function()
    task.wait(1)
    if autoInfCastleSpeed and selectedCastleSpeed then
        fireSafe({
            Event = "CastleAction",
            Action = "SpeedUp",
            Speed = selectedCastleSpeed
        })
    end
end)

-- Hook GUI per rilevare wave
task.spawn(function()
    local gui = player:WaitForChild("PlayerGui")
    for _,v in ipairs(gui:GetDescendants()) do
        detectCastleWaveLabel(v)
    end
    gui.DescendantAdded:Connect(detectCastleWaveLabel)
end)

-- --- AUTCLICK PATCH DA SCRIPT NATIVO ---
local autoClickEnabled = false

MiscTab:CreateToggle({
    Name = "Auto Click (Arma Nativa, Fast)",
    CurrentValue = false,
    Flag = "AutoClickFlag",
    Callback = function(v)
        autoClickEnabled = v
        if v then
            task.spawn(function()
                while autoClickEnabled do
                    require(game:GetService("ReplicatedStorage").SharedModules.WeaponsModule).Click({
                        KeyCode = Enum.KeyCode.ButtonX;
                    }, false, nil, true)
                    task.wait(0.03)
                end
            end)
        end
    end
})

MiscTab:CreateToggle({
    Name = "Auto Blood Weapon Switch",
    CurrentValue = false,
    Flag = "AutoBloodWeaponSwitchFlag",
    Callback = function(v)
        autoBloodWeaponSwitch = v
        if v then
            task.spawn(function()
                while autoBloodWeaponSwitch do
                    fireSafe({Event="Teams", Action="Equip", TeamId="ced2"})
                    task.wait(2)
                    fireSafe({Event="Teams", Action="Equip", TeamId="f2ae"})
                    task.wait(15)
                end
            end)
        end
    end
})

player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end)

dataRemoteEvent.OnClientEvent:Connect(function(...)
    local function scan(tbl)
        if type(tbl) ~= "table" then return end
        for _, v in pairs(tbl) do
            if type(v) == "table" then scan(v)
            elseif type(v) == "string" then
                local msg = v:upper()
                if msg:find("PORTAL") and msg:find("DESTROY") then
                    if autoRestartCastle then restartCastle() end
                    if autoRestartDesert then restartDesert() end
                    if autoRestartLabyrinth then restartLabyrinth() end
                end
                if msg:find("RUSH") and msg:find("END") then
                    if autoRestartCemetryRush then restartCemetryRush() end
                end
            end
        end
    end
    for _, v in ipairs({...}) do scan(v) end
end)

Rayfield:LoadConfiguration("InfiniteModesHub")
