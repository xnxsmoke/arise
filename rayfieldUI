local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

--// Remote Events
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")
local identifierStorage = ReplicatedStorage:WaitForChild("identifierStorage")

--// Funzione per ottenere la key dinamica (es. \003, \004, ecc.)
local function getCurrentKey()
	local key = identifierStorage:GetAttribute("GENERAL_EVENT")
	if typeof(key) ~= "string" then
		repeat
			task.wait(0.2)
			key = identifierStorage:GetAttribute("GENERAL_EVENT")
		until typeof(key) == "string"
	end
	return key
end

--// CFrame posizioni
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.981415, 1594.494141, -4312.195801)

--// UI Window
local Window = Rayfield:CreateWindow({
	Name = "xnxsmoke Hub",
	LoadingTitle = "xnxsmoke Loader",
	LoadingSubtitle = "by xnxsmoke",
	ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true },
})

--// Tabs
local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

--// Variables
local standCastleEnabled, standDesertEnabled, autoRestartCastle, autoRestartDesert = false, false, false, false
local autoRestartLabyrinth, autoRestartCemetryRush = false, false
local standCemetryRushEnabled = false
local cemetryRushDifficulty = "Insane"
local useCemetryRushMode = false
local autoClickEnabled, autoBloodWeaponSwitch = false, false

--// Funzioni Utility
local function safeStandAt(cf)
	local char = player.Character
	if char and char:FindFirstChild("HumanoidRootPart") then
		pcall(function() char.HumanoidRootPart.CFrame = cf end)
	end
end

local function fireSafe(args)
	pcall(function()
		local key = getCurrentKey()
		dataRemoteEvent:FireServer(args, key)
	end)
end

local function safeRejoin(callback)
	task.spawn(function()
		local success, attempts = false, 0
		while not success and attempts < 5 do
			attempts += 1
			task.wait(math.random(3,6))
			local ok, err = pcall(callback)
			if ok then success = true else warn(err) end
		end
	end)
end

--// Funzione Wave Speed (usa sempre la key corretta)
local function speedUp(eventName, speed)
	task.spawn(function()
		repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		task.wait(2)
		local key = getCurrentKey()
		dataRemoteEvent:FireServer({
			{ Event = eventName, Speed = speed, Action = "SpeedUp" },
			key
		})
	end)
end

--// Infinite Castle
local function startCastle()
	local key = getCurrentKey()
	dataRemoteEvent:FireServer({ { Event = "InfiniteCastleAction", Action = "Create" }, key })
	task.wait(1)
	dataRemoteEvent:FireServer({ { Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" }, key })
	task.wait(1)
	if standCastleEnabled then safeStandAt(castleCFrame) end
end

CastleTab:CreateButton({ Name = "Start Infinite Castle (Manual)", Callback = startCastle })
CastleTab:CreateToggle({ Name = "Stand in the Middle (InfCastle)", CurrentValue = false, Callback = function(v) standCastleEnabled=v if v then safeStandAt(castleCFrame) end end })
CastleTab:CreateToggle({ Name = "Auto-Restart (on Portal Destroyed)", CurrentValue = false, Callback = function(v) autoRestartCastle=v end })
CastleTab:CreateToggle({
	Name = "Wave Speed 3",
	CurrentValue = false,
	Callback = function(v)
		if v then speedUp("InfiniteCastleAction", 3) end
	end
})

--// Infinite Desert
local function startDesert()
	local key = getCurrentKey()
	dataRemoteEvent:FireServer({ { Event = "InfiniteModeAction", Action = "Create" }, key })
	task.wait(1)
	dataRemoteEvent:FireServer({ { Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" }, key })
	task.wait(1)
	if standDesertEnabled then safeStandAt(desertCFrame) end
end

DesertTab:CreateButton({ Name = "Start Infinite Desert (Manual)", Callback=startDesert })
DesertTab:CreateToggle({ Name="Stand in the Middle (InfDesert)", CurrentValue=false, Callback=function(v) standDesertEnabled=v if v then safeStandAt(desertCFrame) end end })
DesertTab:CreateToggle({ Name="Auto-Restart (on Portal Destroyed)", CurrentValue=false, Callback=function(v) autoRestartDesert=v end })
DesertTab:CreateToggle({
	Name="Wave Speed 2",
	CurrentValue=false,
	Callback=function(v) if v then speedUp("InfiniteModeAction", 2) end end
})
DesertTab:CreateToggle({
	Name="Wave Speed 3",
	CurrentValue=false,
	Callback=function(v) if v then speedUp("InfiniteModeAction", 3) end end
})

--// Infinite Labyrinth
local function startLabyrinth()
	local key = getCurrentKey()
	dataRemoteEvent:FireServer({ { Event = "InfiniteLabyrinthAction", Action = "Create" }, key })
	task.wait(1)
	dataRemoteEvent:FireServer({ { Dungeon = 3604563306, Event = "InfiniteLabyrinthAction", Action = "Start" }, key })
end

local LabTab = Window:CreateTab("InfLab", 4483362458)
LabTab:CreateButton({ Name = "Start Infinite Labyrinth (Manual)", Callback = startLabyrinth })
LabTab:CreateToggle({ Name="Speed 1", CurrentValue=false, Callback=function(v) if v then speedUp("InfiniteLabyrinthAction", 1) end end })
LabTab:CreateToggle({ Name="Speed 2", CurrentValue=false, Callback=function(v) if v then speedUp("InfiniteLabyrinthAction", 2) end end })
LabTab:CreateToggle({ Name="Speed 3", CurrentValue=false, Callback=function(v) if v then speedUp("InfiniteLabyrinthAction", 3) end end })

--// Cemetry Rush
local function startCemetryRush()
	if not useCemetryRushMode then return end
	local key = getCurrentKey()
	dataRemoteEvent:FireServer({ { Event = "BossRushAction", Action = "Create" }, key })
	task.wait(1)
	dataRemoteEvent:FireServer({ { Dungeon = 3604563306, Action = "Start", Diff = cemetryRushDifficulty, Event = "BossRushAction" }, key })
	if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end

CemetryRushTab:CreateButton({ Name="Start CemetryRush (Manual)", Callback=startCemetryRush })
CemetryRushTab:CreateToggle({ Name="Stand in the Middle", CurrentValue=false, Callback=function(v) standCemetryRushEnabled=v if v then safeStandAt(cemetryRushCFrame) end end })
CemetryRushTab:CreateDropdown({ Name = "Select Difficulty", Options = {"Easy","Medium","Hard","Insane"}, CurrentOption = "Insane", Callback=function(opt) cemetryRushDifficulty = opt end })
CemetryRushTab:CreateToggle({ Name="Activate Selected Difficulty", CurrentValue=false, Callback=function(v) useCemetryRushMode=v end })

--// Auto Click e Auto Weapon Switch
MiscTab:CreateToggle({
	Name = "Auto Click (PunchAttack, Fast)",
	CurrentValue = false,
	Callback = function(v)
		autoClickEnabled = v
		if v then
			task.spawn(function()
				while autoClickEnabled do
					task.wait(0.01)
					local key = getCurrentKey()
					dataRemoteEvent:FireServer({ { Event = "PunchAttack" }, key })
				end
			end)
		end
	end
})

MiscTab:CreateToggle({
	Name = "Auto Blood Weapon Switch",
	CurrentValue = false,
	Callback = function(v)
		autoBloodWeaponSwitch = v
		if v then
			task.spawn(function()
				while autoBloodWeaponSwitch do
					local key = getCurrentKey()
					dataRemoteEvent:FireServer({ { Action="Equip", Event="Teams", TeamId="ced2" }, key })
					task.wait(2)
					dataRemoteEvent:FireServer({ { Action="Equip", Event="Teams", TeamId="f2ae" }, key })
					task.wait(15)
				end
			end)
		end
	end
})

print("âœ… xnxsmoke Hub loaded with dynamic key system.")
