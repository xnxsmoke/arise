local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- =================== Bridge Key Tracking ===================
local currentBridgeKey = "\003" -- valore iniziale fallback
dataRemoteEvent.OnClientEvent:Connect(function(...)
	for _, v in ipairs({...}) do
		if type(v) == "string" and v:match("^\\") then
			currentBridgeKey = v
		end
	end
end)

-- =================== Locations ===================
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.981415, 1594.494141, -4312.195801)

-- =================== Window ===================
local Window = Rayfield:CreateWindow({
	Name = "xnxsmoke Hub",
	LoadingTitle = "xnxsmoke Loader",
	LoadingSubtitle = "by xnxsmoke",
	ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true },
})

local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local HospRaidTab = Window:CreateTab("HospRaid", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- =================== Variables ===================
local standCastleEnabled, standDesertEnabled, autoRestartCastle, autoRestartDesert = false, false, false, false
local autoClickEnabled, waveSpeed2DesertEnabled, waveSpeed3DesertEnabled = false, false, false
local autoRestartLabyrinth, speed1LabyrinthEnabled, speed2LabyrinthEnabled, speed3LabyrinthEnabled = false, false, false, false
local arlecchinoKeyEnabled, joinedHospRaid, teamSwitchEnabled = false, false, false
local standCemetryRushEnabled, autoRestartCemetryRush = false, false

-- =================== Utility Functions ===================
local function safeStandAt(cf)
	local char = player.Character
	if char and char:FindFirstChild("HumanoidRootPart") then
		pcall(function() char.HumanoidRootPart.CFrame = cf end)
	end
end

local function fireSafe(args)
	pcall(function() dataRemoteEvent:FireServer(unpack(args)) end)
end

local function safeRejoin(joinFunction)
	task.spawn(function()
		local success, attempts = false, 0
		while not success and attempts < 5 do
			attempts += 1
			task.wait(math.random(3, 6))
			local ok, err = pcall(joinFunction)
			if ok then success = true else warn(err) end
		end
	end)
end

local function speedUp(modeEvent, speed)
	local args = {
		{ { Speed = speed, Event = modeEvent, Action = "SpeedUp" }, currentBridgeKey }
	}
	fireSafe(args)
end

-- =================== InfCastle ===================
local function startCastle()
	fireSafe({ { { Event = "InfiniteCastleAction", Action = "Create" }, currentBridgeKey } })
	task.wait(1)
	fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" }, currentBridgeKey } })
	task.wait(1)
	if standCastleEnabled then safeStandAt(castleCFrame) end
end
local function restartCastle() safeRejoin(startCastle) end

CastleTab:CreateButton({ Name = "Start Infinite Castle (Manual)", Callback = startCastle })
CastleTab:CreateToggle({
	Name = "Stand in the Middle (InfCastle)",
	CurrentValue = false,
	Flag = "StandCastleFlag",
	Callback = function(v)
		standCastleEnabled = v
		if v then safeStandAt(castleCFrame) end
	end,
})
CastleTab:CreateToggle({
	Name = "Auto-Restart (on Portal Destroyed)",
	CurrentValue = false,
	Flag = "AutoRestartCastleFlag",
	Callback = function(v) autoRestartCastle = v end,
})
CastleTab:CreateToggle({
	Name = "Wave Speed 3",
	CurrentValue = false,
	Flag = "WaveSpeed3Flag",
	Callback = function(v)
		if v then
			task.spawn(function()
				repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
				task.wait(2)
				speedUp("InfiniteCastleAction", 3)
			end)
		end
	end,
})

-- =================== InfDesert ===================
local function startDesert()
	fireSafe({ { { Event = "InfiniteModeAction", Action = "Create" }, currentBridgeKey } })
	task.wait(1)
	fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" }, currentBridgeKey } })
	task.wait(1)
	if standDesertEnabled then safeStandAt(desertCFrame) end
end
local function restartDesert() safeRejoin(startDesert) end

DesertTab:CreateButton({ Name = "Start Infinite Desert (Manual)", Callback = startDesert })
DesertTab:CreateToggle({
	Name = "Stand in the Middle (InfDesert)",
	CurrentValue = false,
	Flag = "StandDesertFlag",
	Callback = function(v)
		standDesertEnabled = v
		if v then safeStandAt(desertCFrame) end
	end,
})
DesertTab:CreateToggle({
	Name = "Auto-Restart (on Portal Destroyed)",
	CurrentValue = false,
	Flag = "AutoRestartDesertFlag",
	Callback = function(v) autoRestartDesert = v end,
})
DesertTab:CreateToggle({
	Name = "Wave Speed 2",
	CurrentValue = false,
	Flag = "WaveSpeed2DesertFlag",
	Callback = function(v)
		if v then
			waveSpeed3DesertEnabled = false
			Rayfield.Flags["WaveSpeed3DesertFlag"].Set(false)
			task.spawn(function()
				repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
				task.wait(2)
				speedUp("InfiniteModeAction", 2)
			end)
		end
	end,
})
DesertTab:CreateToggle({
	Name = "Wave Speed 3",
	CurrentValue = false,
	Flag = "WaveSpeed3DesertFlag",
	Callback = function(v)
		if v then
			waveSpeed2DesertEnabled = false
			Rayfield.Flags["WaveSpeed2DesertFlag"].Set(false)
			task.spawn(function()
				repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
				task.wait(2)
				speedUp("InfiniteModeAction", 3)
			end)
		end
	end,
})

-- =================== Infinite Labyrinth ===================
local function startLabyrinth()
	fireSafe({ { { Event = "InfiniteLabyrinthAction", Action = "Create" }, currentBridgeKey } })
	task.wait(1)
	fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteLabyrinthAction", Action = "Start" }, currentBridgeKey } })
end
local function restartLabyrinth() safeRejoin(startLabyrinth) end

LabTab:CreateButton({ Name = "Start Infinite Labyrinth (Manual)", Callback = startLabyrinth })
LabTab:CreateToggle({
	Name = "Auto-Restart (on Portal Destroyed)",
	CurrentValue = false,
	Flag = "AutoRestartLabyrinthFlag",
	Callback = function(v) autoRestartLabyrinth = v end,
})
LabTab:CreateToggle({
	Name = "Speed 1",
	CurrentValue = false,
	Flag = "Speed1LabyrinthFlag",
	Callback = function(v)
		if v then
			Rayfield.Flags["Speed2LabyrinthFlag"].Set(false)
			Rayfield.Flags["Speed3LabyrinthFlag"].Set(false)
			speedUp("InfiniteLabyrinthAction", 1)
		end
	end,
})
LabTab:CreateToggle({
	Name = "Speed 2",
	CurrentValue = false,
	Flag = "Speed2LabyrinthFlag",
	Callback = function(v)
		if v then
			Rayfield.Flags["Speed1LabyrinthFlag"].Set(false)
			Rayfield.Flags["Speed3LabyrinthFlag"].Set(false)
			speedUp("InfiniteLabyrinthAction", 2)
		end
	end,
})
LabTab:CreateToggle({
	Name = "Speed 3",
	CurrentValue = false,
	Flag = "Speed3LabyrinthFlag",
	Callback = function(v)
		if v then
			Rayfield.Flags["Speed1LabyrinthFlag"].Set(false)
			Rayfield.Flags["Speed2LabyrinthFlag"].Set(false)
			speedUp("InfiniteLabyrinthAction", 3)
		end
	end,
})

-- =================== Misc ===================
MiscTab:CreateToggle({
	Name = "Auto Click",
	CurrentValue = false,
	Flag = "AutoClickFlag",
	Callback = function(v)
		autoClickEnabled = v
		if v then
			task.spawn(function()
				local WeaponsModule = require(ReplicatedStorage.SharedModules.WeaponsModule)
				while autoClickEnabled do
					task.wait(0.1)
					pcall(function() WeaponsModule.Click({ KeyCode = Enum.KeyCode.ButtonX }, false, nil, true) end)
				end
			end)
		end
	end,
})

MiscTab:CreateToggle({
	Name = "Arlecchino Key",
	CurrentValue = false,
	Flag = "ArlecchinoKeyFlag",
	Callback = function(v)
		arlecchinoKeyEnabled = v
		if v then
			task.spawn(function()
				while arlecchinoKeyEnabled do
					local args = { { { Event = "CraftItem", Name = "HLKeyBeru" }, currentBridgeKey } }
					fireSafe(args)
					task.wait(3)
				end
			end)
		end
	end,
})

-- NEW: Team Switch DMG ⇄ WEAP
MiscTab:CreateToggle({
	Name = "Auto Team Switch (DMG ⇄ WEAP)",
	CurrentValue = false,
	Flag = "AutoTeamSwitchFlag",
	Callback = function(v)
		teamSwitchEnabled = v
		if v then
			task.spawn(function()
				while teamSwitchEnabled do
					-- switch to WEAP
					fireSafe({ { { Action = "Equip", Event = "Teams", TeamId = "ced2" }, currentBridgeKey } })
					task.wait(15)
					-- back to DMG
					fireSafe({ { { Action = "Equip", Event = "Teams", TeamId = "f2ae" }, currentBridgeKey } })
					task.wait(2)
				end
			end)
		end
	end,
})

-- =================== HospRaid ===================
local function joinHospRaid()
	if joinedHospRaid then return end
	joinedHospRaid = true
	local args = { { { Event = "HLRaidAction", Action = "Join" }, currentBridgeKey } }
	fireSafe(args)
end
HospRaidTab:CreateToggle({
	Name = "Join HospRaid",
	CurrentValue = false,
	Flag = "JoinHospRaidFlag",
	Callback = function(v)
		if v then joinHospRaid() end
	end,
})

-- =================== CemetryRush ===================
local function startCemetryRush()
	fireSafe({ { { Event = "BossRushAction", Action = "Create" }, currentBridgeKey } })
	task.wait(1)
	fireSafe({ { { Dungeon = 3604563306, Action = "Start", Diff = "Hard", Event = "BossRushAction" }, currentBridgeKey } })
	if standCemetryRushEnabled then
		task.spawn(function()
			repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
			safeStandAt(cemetryRushCFrame)
		end)
	end
end
local function restartCemetryRush() safeRejoin(startCemetryRush) end

CemetryRushTab:CreateButton({ Name = "Start CemetryRush (Manual)", Callback = startCemetryRush })
CemetryRushTab:CreateToggle({
	Name = "Stand in the Middle",
	CurrentValue = false,
	Flag = "StandCemetryRushFlag",
	Callback = function(v)
		standCemetryRushEnabled = v
		if v then safeStandAt(cemetryRushCFrame) end
	end,
})
CemetryRushTab:CreateToggle({
	Name = "Auto-Restart (on Rush Ended)",
	CurrentValue = false,
	Flag = "AutoRestartCemetryRushFlag",
	Callback = function(v) autoRestartCemetryRush = v end,
})

-- =================== Teleport on Respawn ===================
player.CharacterAdded:Connect(function()
	task.wait(1)
	if standCastleEnabled then safeStandAt(castleCFrame) end
	if standDesertEnabled then safeStandAt(desertCFrame) end
	if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end)

-- =================== Auto-Restart Global ===================
dataRemoteEvent.OnClientEvent:Connect(function(...)
	local function recursiveCheck(tbl)
		if type(tbl) ~= "table" then return end
		for k, v in pairs(tbl) do
			if type(v) == "table" then recursiveCheck(v)
			elseif type(v) == "string" then
				local msg = v:upper()
				if msg:find("PORTAL DESTROYED") then
					if autoRestartCastle then restartCastle() end
					if autoRestartDesert then restartDesert() end
					if autoRestartLabyrinth then restartLabyrinth() end
				elseif msg:find("RUSH ENDED") then
					if autoRestartCemetryRush then restartCemetryRush() end
				end
			end
		end
	end
	for _, v in ipairs({...}) do recursiveCheck(v) end
end)

-- =================== Load Config ===================
Rayfield:LoadConfiguration("InfiniteModesHub")
