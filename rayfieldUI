local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local BridgeNet2 = ReplicatedStorage:WaitForChild("BridgeNet2")
local Bridge = require(BridgeNet2).ReferenceBridge("GENERAL_EVENT")
local dataRemoteEvent = BridgeNet2:WaitForChild("dataRemoteEvent")

local function fireSafe(data)
    pcall(function() Bridge:Fire(data) end)
end

local function safeStandAt(cf)
    local c = player.Character
    if c and c:FindFirstChild("HumanoidRootPart") then
        c.HumanoidRootPart.CFrame = cf
    end
end

local function safeRejoin(fn)
    task.spawn(function()
        for i = 1, 5 do
            if pcall(fn) then return end
            task.wait(math.random(3, 6))
        end
    end)
end

local function speedUp(eventName, speed)
    task.spawn(function()
        repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        task.wait(2)
        fireSafe({Event = eventName, Action = "SpeedUp", Speed = speed})
    end)
end

local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.9814, 1594.4941, -4312.1958)

local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = {
        Enabled = true,
        FileName = "InfiniteModesHub",
        AutoSave = true
    },
})

local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

local standCastleEnabled = false
local standDesertEnabled = false
local standCemetryRushEnabled = false

local autoRestartCastle = false
local autoRestartDesert = false
local autoRestartLabyrinth = false
local autoRestartCemetryRush = false

local cemetryRushDifficulty = "Insane"
local useCemetryRushMode = false

local autoClickEnabled = false
local autoBloodWeaponSwitch = false

----------------------------------------------------
-- CASTLE
----------------------------------------------------

local function startCastle()
    fireSafe({Event = "InfiniteCastleAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteCastleAction", Action = "Start", Dungeon = 3604563306})
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
end

local function restartCastle()
    safeRejoin(startCastle)
end

CastleTab:CreateButton({
    Name = "Start Infinite Castle (Manual)",
    Callback = startCastle
})

CastleTab:CreateToggle({
    Name = "Stand in the Middle (InfCastle)",
    CurrentValue = false,
    Flag = "StandCastleFlag",
    Callback = function(v)
        standCastleEnabled = v
        if v then safeStandAt(castleCFrame) end
    end
})

CastleTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartCastleFlag",
    Callback = function(v) autoRestartCastle = v end
})

CastleTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3CastleFlag",
    Callback = function(v)
        if v then speedUp("InfiniteCastleAction", 3) end
    end
})

----------------------------------------------------
-- DESERT
----------------------------------------------------

local function startDesert()
    fireSafe({Event = "InfiniteModeAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteModeAction", Action = "Start", Dungeon = 3604563306})
    task.wait(1)
    if standDesertEnabled then safeStandAt(desertCFrame) end
end

local function restartDesert()
    safeRejoin(startDesert)
end

DesertTab:CreateButton({
    Name = "Start Infinite Desert (Manual)",
    Callback = startDesert
})

DesertTab:CreateToggle({
    Name = "Stand in the Middle (InfDesert)",
    CurrentValue = false,
    Flag = "StandDesertFlag",
    Callback = function(v)
        standDesertEnabled = v
        if v then safeStandAt(desertCFrame) end
    end
})

DesertTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartDesertFlag",
    Callback = function(v) autoRestartDesert = v end
})

DesertTab:CreateToggle({
    Name = "Wave Speed 2",
    CurrentValue = false,
    Flag = "WaveSpeed2DesertFlag",
    Callback = function(v)
        if v then speedUp("InfiniteModeAction", 2) end
    end
})

DesertTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue = false,
    Flag = "WaveSpeed3DesertFlag",
    Callback = function(v)
        if v then speedUp("InfiniteModeAction", 3) end
    end
})

----------------------------------------------------
-- LABYRINTH
----------------------------------------------------

local function startLabyrinth()
    fireSafe({Event = "InfiniteLabyrinthAction", Action = "Create"})
    task.wait(1)
    fireSafe({Event = "InfiniteLabyrinthAction", Action = "Start", Dungeon = 3604563306})
end

local function restartLabyrinth()
    safeRejoin(startLabyrinth)
end

LabTab:CreateButton({
    Name = "Start Infinite Labyrinth (Manual)",
    Callback = startLabyrinth
})

LabTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue = false,
    Flag = "AutoRestartLabyrinthFlag",
    Callback = function(v) autoRestartLabyrinth = v end
})

LabTab:CreateToggle({
    Name = "Speed 3",
    CurrentValue = false,
    Flag = "Speed3LabyrinthFlag",
    Callback = function(v)
        if v then speedUp("InfiniteLabyrinthAction", 3) end
    end
})

----------------------------------------------------
-- BOSS RUSH (UPDATED WITH ULTRA)
----------------------------------------------------

local function startCemetryRush()
    if not useCemetryRushMode then return end

    fireSafe({Event = "BossRushAction", Action = "Create"})
    task.wait(1)

    fireSafe({
        Event = "BossRushAction",
        Action = "Start",
        Dungeon = 3604563306,
        Diff = cemetryRushDifficulty
    })

    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end

local function restartCemetryRush()
    safeRejoin(startCemetryRush)
end

CemetryRushTab:CreateButton({
    Name = "Start CemetryRush (Manual)",
    Callback = startCemetryRush
})

CemetryRushTab:CreateToggle({
    Name = "Stand in the Middle",
    CurrentValue = false,
    Flag = "StandCemetryRushFlag",
    Callback = function(v)
        standCemetryRushEnabled = v
        if v then safeStandAt(cemetryRushCFrame) end
    end
})

CemetryRushTab:CreateDropdown({
    Name = "Select Difficulty",
    Options = {"Easy", "Medium", "Hard", "Insane", "Ultra"},
    CurrentOption = "Insane",
    Flag = "CemetryRushDifficultyFlag",
    Callback = function(opt)
        cemetryRushDifficulty = tostring(opt)
    end
})

CemetryRushTab:CreateToggle({
    Name = "Activate Selected Difficulty",
    CurrentValue = false,
    Flag = "UseCemetryRushDifficultyFlag",
    Callback = function(v) useCemetryRushMode = v end
})

CemetryRushTab:CreateToggle({
    Name = "Auto-Restart (on Rush Ended)",
    CurrentValue = false,
    Flag = "AutoRestartCemetryRushFlag",
    Callback = function(v) autoRestartCemetryRush = v end
})

----------------------------------------------------
-- MISC
----------------------------------------------------

MiscTab:CreateToggle({
    Name = "Auto Click (PunchAttack, Fast)",
    CurrentValue = false,
    Flag = "AutoClickFlag",
    Callback = function(v)
        autoClickEnabled = v
        if v then
            task.spawn(function()
                while autoClickEnabled do
                    task.wait(0.01)
                    fireSafe({Event = "PunchAttack"})
                end
            end)
        end
    end
})

MiscTab:CreateToggle({
    Name = "Auto Blood Weapon Switch",
    CurrentValue = false,
    Flag = "AutoBloodWeaponSwitchFlag",
    Callback = function(v)
        autoBloodWeaponSwitch = v
        if v then
            task.spawn(function()
                while autoBloodWeaponSwitch do
                    fireSafe({Event = "Teams", Action = "Equip", TeamId = "ced2"})
                    task.wait(2)
                    fireSafe({Event = "Teams", Action = "Equip", TeamId = "f2ae"})
                    task.wait(15)
                end
            end)
        end
    end
})

----------------------------------------------------
-- AUTO RESTART HANDLER
----------------------------------------------------

dataRemoteEvent.OnClientEvent:Connect(function(...)
    local function scan(tbl)
        if type(tbl) ~= "table" then return end
        for _, v in pairs(tbl) do
            if type(v) == "table" then scan(v)
            elseif type(v) == "string" then
                local msg = v:upper()
                if msg:find("PORTAL") and msg:find("DESTROY") then
                    if autoRestartCastle then restartCastle() end
                    if autoRestartDesert then restartDesert() end
                    if autoRestartLabyrinth then restartLabyrinth() end
                end
                if msg:find("RUSH") and msg:find("END") then
                    if autoRestartCemetryRush then restartCemetryRush() end
                end
            end
        end
    end
    for _, v in ipairs({...}) do scan(v) end
end)

----------------------------------------------------
-- RESPAWN TP
----------------------------------------------------

player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end)

----------------------------------------------------
Rayfield:LoadConfiguration("InfiniteModesHub")
