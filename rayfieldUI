local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

local KEY = "\003"

-- Positions
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)

-- UI
local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true },
})

local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)

-- Variables
local standCastleEnabled, autoRestartCastle = false, false
local standDesertEnabled, autoRestartDesert = false, false
local waveCastle = 1
local waveDesert = 1
local checkpointCastle = 0
local checkpointDesert = 0

-- Utility
local function safeStandAt(cf)
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        pcall(function() char.HumanoidRootPart.CFrame = cf end)
    end
end

local function fire(args)
    pcall(function() dataRemoteEvent:FireServer(unpack(args)) end)
end

local function safeRejoin(joinFunction)
    task.spawn(function()
        local success, attempts = false, 0
        while not success and attempts < 5 do
            attempts += 1
            task.wait(math.random(3,6))
            local ok, err = pcall(joinFunction)
            if ok then success = true else warn(err) end
        end
    end)
end

local function speedUpCastle(speed)
    fire({{{Speed=speed, Event="InfiniteCastleAction", Action="SpeedUp"}, KEY}})
end

local function speedUpDesert(speed)
    fire({{{Speed=speed, Event="InfiniteModeAction", Action="SpeedUp"}, KEY}})
end

-- InfCastle
local function startCastle()
    fire({{{Event="InfiniteCastleAction", Action="Create"}, KEY}})
    task.wait(1)
    local startArgs = {
        {
            {
                Action="Start",
                Event="InfiniteCastleAction",
                Dungeon=3604563306
            },
            KEY
        }
    }
    if checkpointCastle > 0 then
        startArgs[1][1].Check = tostring(checkpointCastle)
    end
    fire(startArgs)
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    speedUpCastle(waveCastle)
end

local function restartCastle()
    safeRejoin(startCastle)
end

CastleTab:CreateButton({Name="Start InfCastle", Callback=startCastle})
CastleTab:CreateToggle({Name="Stand in Middle", CurrentValue=false, Flag="StandCastleFlag", Callback=function(v) standCastleEnabled=v if v then safeStandAt(castleCFrame) end end})
CastleTab:CreateDropdown({
    Name="Wave",
    Options={"1","2","3"},
    CurrentOption="1",
    Flag="WaveCastleFlag",
    Callback=function(v) waveCastle = tonumber(v) end
})
CastleTab:CreateDropdown({
    Name="Checkpoint",
    Options={"0","30","60","90","120","150","180","210","240","270","300","330","360","390","420"},
    CurrentOption="0",
    Flag="CheckpointCastleFlag",
    Callback=function(v) checkpointCastle = tonumber(v) end
})
CastleTab:CreateToggle({Name="Auto-Restart", CurrentValue=false, Flag="AutoRestartCastleFlag", Callback=function(v) autoRestartCastle=v end})

-- InfDesert
local function startDesert()
    fire({{{Event="InfiniteModeAction", Action="Create"}, KEY}})
    task.wait(1)
    local startArgs = {
        {
            {
                Action="Start",
                Event="InfiniteModeAction",
                Dungeon=3604563306
            },
            KEY
        }
    }
    if checkpointDesert > 0 then
        startArgs[1][1].Check = tostring(checkpointDesert)
    end
    fire(startArgs)
    task.wait(1)
    if standDesertEnabled then safeStandAt(desertCFrame) end
    speedUpDesert(waveDesert)
end

local function restartDesert()
    safeRejoin(startDesert)
end

DesertTab:CreateButton({Name="Start InfDesert", Callback=startDesert})
DesertTab:CreateToggle({Name="Stand in Middle", CurrentValue=false, Flag="StandDesertFlag", Callback=function(v) standDesertEnabled=v if v then safeStandAt(desertCFrame) end end})
DesertTab:CreateDropdown({
    Name="Wave",
    Options={"1","2","3"},
    CurrentOption="1",
    Flag="WaveDesertFlag",
    Callback=function(v) waveDesert = tonumber(v) end
})
DesertTab:CreateDropdown({
    Name="Checkpoint",
    Options={"0","30","60","90","120","150","180","210","240","270","300","330","360","390","420"},
    CurrentOption="0",
    Flag="CheckpointDesertFlag",
    Callback=function(v) checkpointDesert = tonumber(v) end
})
DesertTab:CreateToggle({Name="Auto-Restart", CurrentValue=false, Flag="AutoRestartDesertFlag", Callback=function(v) autoRestartDesert=v end})

-- Respawn
player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
end)

-- Restart detection
dataRemoteEvent.OnClientEvent:Connect(function(...)
    local function recursiveCheck(tbl)
        if type(tbl) ~= "table" then return end
        for _,v in pairs(tbl) do
            if type(v)=="table" then recursiveCheck(v)
            elseif type(v)=="string" then
                local msg=v:upper()
                if msg:find("PORTAL DESTROYED") then
                    if autoRestartCastle then restartCastle() end
                    if autoRestartDesert then restartDesert() end
                end
            end
        end
    end
    for _,v in ipairs({...}) do recursiveCheck(v) end
end)

Rayfield:LoadConfiguration("InfiniteModesHub")
