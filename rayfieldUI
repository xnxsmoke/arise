local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

--// Positions
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local cemetryRushCFrame = CFrame.new(214.981415, 1594.494141, -4312.195801)

--// UI Window
local Window = Rayfield:CreateWindow({
    Name = "xnxsmoke Hub",
    LoadingTitle = "xnxsmoke Loader",
    LoadingSubtitle = "by xnxsmoke",
    ConfigurationSaving = { Enabled = true, FileName = "InfiniteModesHub", AutoSave = true },
})

--// Tabs
local CastleTab = Window:CreateTab("InfCastle", 4483362458)
local DesertTab = Window:CreateTab("InfDesert", 4483362458)
local LabTab = Window:CreateTab("InfLab", 4483362458)
local HospRaidTab = Window:CreateTab("HospRaid", 4483362458)
local CemetryRushTab = Window:CreateTab("CemetryRush", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

--// Variables
local standCastleEnabled, standDesertEnabled, autoRestartCastle, autoRestartDesert = false, false, false, false
local autoClickEnabled, waveSpeed2DesertEnabled, waveSpeed3DesertEnabled = false, false, false
local autoRestartLabyrinth, speed1LabyrinthEnabled, speed2LabyrinthEnabled, speed3LabyrinthEnabled = false, false, false, false
local joinedHospRaid = false
local standCemetryRushEnabled, autoRestartCemetryRush = false, false
local teamSwitchEnabled = false
local cemetryRushDifficulty = "Insane"
local useCemetryRushMode = false

--// Utility
local function safeStandAt(cf)
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        pcall(function() char.HumanoidRootPart.CFrame = cf end)
    end
end

local function fireSafe(args)
    pcall(function() dataRemoteEvent:FireServer(unpack(args)) end)
end

local function safeRejoin(joinFunction)
    task.spawn(function()
        local success, attempts = false, 0
        while not success and attempts < 5 do
            attempts += 1
            task.wait(math.random(3,6))
            local ok, err = pcall(joinFunction)
            if ok then success = true else warn(err) end
        end
    end)
end

--// Wave Speed helpers
local function speedUpCastle(speed)
    fireSafe({ { { Speed = speed, Event = "InfiniteCastleAction", Action = "SpeedUp" }, "\003" } })
end

local function speedUpDesert(speed)
    fireSafe({ { { Speed = speed, Event = "InfiniteModeAction", Action = "SpeedUp" }, "\003" } })
end

--// InfCastle
local function startCastle()
    fireSafe({ { { Event = "InfiniteCastleAction", Action = "Create" }, "\003" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" }, "\003" } })
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
end
local function restartCastle() safeRejoin(startCastle) end

CastleTab:CreateButton({ Name = "Start Infinite Castle (Manual)", Callback = startCastle })
CastleTab:CreateToggle({
    Name = "Stand in the Middle (InfCastle)",
    CurrentValue=false,
    Flag="StandCastleFlag",
    Callback=function(v)
        standCastleEnabled=v
        if v then safeStandAt(castleCFrame) end
    end
})
CastleTab:CreateToggle({
    Name = "Auto-Restart (on Portal Destroyed)",
    CurrentValue=false,
    Flag="AutoRestartCastleFlag",
    Callback=function(v) autoRestartCastle=v end
})
CastleTab:CreateToggle({
    Name = "Wave Speed 3",
    CurrentValue=false,
    Flag="WaveSpeed3Flag",
    Callback=function(v)
        if v then
            task.spawn(function()
                repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                task.wait(2)
                speedUpCastle(3)
            end)
        end
    end
})

--// InfDesert
local function startDesert()
    fireSafe({ { { Event = "InfiniteModeAction", Action = "Create" }, "\003" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" }, "\003" } })
    task.wait(1)
    if standDesertEnabled then safeStandAt(desertCFrame) end
end
local function restartDesert() safeRejoin(startDesert) end

DesertTab:CreateButton({ Name = "Start Infinite Desert (Manual)", Callback=startDesert })
DesertTab:CreateToggle({
    Name="Stand in the Middle (InfDesert)",
    CurrentValue=false,
    Flag="StandDesertFlag",
    Callback=function(v)
        standDesertEnabled=v
        if v then safeStandAt(desertCFrame) end
    end
})
DesertTab:CreateToggle({
    Name="Auto-Restart (on Portal Destroyed)",
    CurrentValue=false,
    Flag="AutoRestartDesertFlag",
    Callback=function(v) autoRestartDesert=v end
})
DesertTab:CreateToggle({
    Name="Wave Speed 2",
    CurrentValue=false,
    Flag="WaveSpeed2DesertFlag",
    Callback=function(v)
        if v then
            task.spawn(function()
                repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                task.wait(2)
                speedUpDesert(2)
            end)
        end
    end
})
DesertTab:CreateToggle({
    Name="Wave Speed 3",
    CurrentValue=false,
    Flag="WaveSpeed3DesertFlag",
    Callback=function(v)
        if v then
            task.spawn(function()
                repeat task.wait(0.1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                task.wait(2)
                speedUpDesert(3)
            end)
        end
    end
})

--// Infinite Labyrinth
local function startLabyrinth()
    fireSafe({ { { Event="InfiniteLabyrinthAction", Action="Create" }, "\003" } })
    task.wait(1)
    fireSafe({ { { Dungeon=3604563306, Event="InfiniteLabyrinthAction", Action="Start" }, "\003" } })
end
local function restartLabyrinth() safeRejoin(startLabyrinth) end

LabTab:CreateButton({ Name="Start Infinite Labyrinth (Manual)", Callback=startLabyrinth })
LabTab:CreateToggle({ Name="Auto-Restart (on Portal Destroyed)", CurrentValue=false, Flag="AutoRestartLabyrinthFlag", Callback=function(v) autoRestartLabyrinth=v end})
LabTab:CreateToggle({ Name="Speed 1", CurrentValue=false, Flag="Speed1LabyrinthFlag", Callback=function(v) if v then fireSafe({ { { Speed = 1, Event = "InfiniteLabyrinthAction", Action = "SpeedUp" }, "\003" } }) end end})
LabTab:CreateToggle({ Name="Speed 2", CurrentValue=false, Flag="Speed2LabyrinthFlag", Callback=function(v) if v then fireSafe({ { { Speed = 2, Event = "InfiniteLabyrinthAction", Action = "SpeedUp" }, "\003" } }) end end})
LabTab:CreateToggle({ Name="Speed 3", CurrentValue=false, Flag="Speed3LabyrinthFlag", Callback=function(v) if v then fireSafe({ { { Speed = 3, Event = "InfiniteLabyrinthAction", Action = "SpeedUp" }, "\003" } }) end end})

--// CemetryRush
local function startCemetryRush()
    if not useCemetryRushMode then return end
    fireSafe({ { { Event="BossRushAction", Action="Create" }, "\003" } })
    task.wait(1)
    fireSafe({ { { Dungeon=3604563306, Action="Start", Diff=cemetryRushDifficulty, Event="BossRushAction" }, "\003" } })
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end
local function restartCemetryRush() safeRejoin(startCemetryRush) end

CemetryRushTab:CreateButton({ Name="Start CemetryRush (Manual)", Callback=startCemetryRush })
CemetryRushTab:CreateToggle({ Name="Stand in the Middle", CurrentValue=false, Flag="StandCemetryRushFlag", Callback=function(v) standCemetryRushEnabled=v if v then safeStandAt(cemetryRushCFrame) end end})
CemetryRushTab:CreateDropdown({
    Name = "Select Difficulty",
    Options = {"Easy", "Medium", "Hard", "Insane"},
    CurrentOption = "Insane",
    Flag = "CemetryRushDifficultyFlag",
    Callback = function(option) cemetryRushDifficulty = option end
})
CemetryRushTab:CreateToggle({
    Name = "Activate Selected Difficulty",
    CurrentValue=false,
    Flag = "UseCemetryRushDifficultyFlag",
    Callback = function(v) useCemetryRushMode = v end
})
CemetryRushTab:CreateToggle({
    Name = "Auto-Restart (on Rush Ended)",
    CurrentValue=false,
    Flag="AutoRestartCemetryRushFlag",
    Callback=function(v) autoRestartCemetryRush=v end
})

--// HospRaid
local function joinHospRaid()
    if joinedHospRaid then return end
    joinedHospRaid = true
    fireSafe({ { { Event="HLRaidAction",Action="Join" }, "\003" } })
end
HospRaidTab:CreateToggle({ Name="Join HospRaid", CurrentValue=false, Flag="JoinHospRaidFlag", Callback=function(v) if v then joinHospRaid() end end})

--// Misc
MiscTab:CreateToggle({
    Name = "Auto Click (PunchAttack, Fast)",
    CurrentValue = false,
    Flag = "AutoClickFlag",
    Callback = function(v)
        autoClickEnabled = v
        if v then
            task.spawn(function()
                while autoClickEnabled do
                    task.wait(0.01)
                    fireSafe({ { { Event = "PunchAttack", Enemy = "b0b7150ea58f45f19cb51136e05dd22e" }, "\003" } })
                end
            end)
        end
    end
})

MiscTab:CreateToggle({
    Name = "Auto Blood Weapon Switch",
    CurrentValue = false,
    Flag = "AutoBloodWeaponSwitchFlag",
    Callback = function(v)
        autoBloodWeaponSwitch = v
        if v then
            task.spawn(function()
                while autoBloodWeaponSwitch do
                    fireSafe({ { { Action = "Equip", Event = "Teams", TeamId = "ced2" }, "\003" } })
                    task.wait(2)
                    fireSafe({ { { Action = "Equip", Event = "Teams", TeamId = "f2ae" }, "\003" } })
                    task.wait(15)
                end
            end)
        end
    end
})

--// Respawn handler
player.CharacterAdded:Connect(function()
    task.wait(1)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
    if standCemetryRushEnabled then safeStandAt(cemetryRushCFrame) end
end)

--// Restart detection
dataRemoteEvent.OnClientEvent:Connect(function(...)
    local function recursiveCheck(tbl)
        if type(tbl) ~= "table" then return end
        for _,v in pairs(tbl) do
            if type(v)=="table" then recursiveCheck(v)
            elseif type(v)=="string" then
                local msg=v:upper()
                if msg:find("PORTAL DESTROYED") or msg:find("CASTLE") then
                    if autoRestartCastle then restartCastle() end
                    if autoRestartDesert then restartDesert() end
                    if autoRestartLabyrinth then restartLabyrinth() end
                elseif msg:find("RUSH ENDED") then
                    if autoRestartCemetryRush then restartCemetryRush() end
                end
            end
        end
    end
    for _,v in ipairs({...}) do recursiveCheck(v) end
end)

Rayfield:LoadConfiguration("InfiniteModesHub")
